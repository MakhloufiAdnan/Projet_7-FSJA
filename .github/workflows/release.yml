# Release — GitHub Release + artefacts (JAR back + build Angular)
# Déclenchement : push d’un tag SemVer vX.Y.Z
name: "Release - GitHub Release + Artifacts"

on:
  push:
    tags:
      - "v*"

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # Créer une Release + on upload des assets => contents: write
    permissions:
      contents: write

    steps:
      - name: Checkout (full history for tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      # ---- Build BACK (Gradle) ----
      - name: Setup Java (Temurin 21)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Setup Gradle (cache)
        uses: gradle/actions/setup-gradle@v4

      - name: Build JAR (back)
        working-directory: back
        run: |
          chmod +x ./gradlew
          ./gradlew --no-daemon clean bootJar

      - name: Collect back artifact
        shell: bash
        run: |
          mkdir -p release-assets
          cp back/build/libs/*.jar release-assets/ || (echo "No jar found" && ls -la back/build/libs && exit 1)

      # ---- Build FRONT (Angular) ----
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"
          cache-dependency-path: front/package-lock.json

      - name: Install (front)
        working-directory: front
        run: npm ci

      - name: Build (front)
        working-directory: front
        run: npm run build

      - name: Collect front artifact
        shell: bash
        run: |
          # On zipe le dossier dist pour l'attacher à la release
          cd front
          if [ ! -d "dist" ]; then
            echo "dist/ not found - check Angular build output"
            ls -la
            exit 1
          fi
          zip -r ../release-assets/front-dist.zip dist

      # ---- Create GitHub Release + upload assets ----
      - name: Create Release & upload assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          TAG="${GITHUB_REF_NAME}"
          # release notes simples (tu pourras les enrichir plus tard)
          NOTES="Release ${TAG}\n\n- Artefacts: back JAR + front dist.zip\n- Images Docker publiées par le workflow cd-images.yml (GHCR)"
          gh release create "${TAG}" release-assets/* --title "${TAG}" --notes "${NOTES}" --verify-tag
